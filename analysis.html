<!DOCTYPE html>
<html>
<head>
<title>Pro Trading Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background:#0f172a; color:#e2e8f0; font-family:Arial; margin:0; }
header { background:#020617; padding:15px; font-size:20px; }
.container { display:grid; grid-template-columns: 300px 1fr; gap:15px; padding:15px; }
.panel { background:#020617; padding:15px; border-radius:12px; }
input,button { width:100%; padding:8px; background:#1e293b; border:none; color:white; margin-bottom:8px; }
button { background:#2563eb; cursor:pointer; }
.metric { margin:6px 0; }
.green{color:#22c55e;} .red{color:#ef4444;} .yellow{color:#facc15;}
table{width:100%; font-size:13px;}
td,th{padding:4px;}
</style>
</head>
<body>

<header>ðŸ“Š Pro Trading Dashboard v2</header>

<div class="container">
  <div class="panel">
    <input id="stock" value="SBIN" />
    <button onclick="run()">Analyze</button>
    <div id="stats"></div>

    <h4>ðŸ“Œ Multi Stock Scanner</h4>
    <button onclick="scan()">Scan Market</button>
    <div id="scanner"></div>
  </div>

  <div class="panel">
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
const API = "https://red-tooth-e4f7.lovelyideas-in.workers.dev?symbol=";

async function fetchData(symbol, interval="5m", range="5d") {
  const res = await fetch(`${API}${symbol}&interval=${interval}&range=${range}`);
  const json = await res.json();

  const r = json.chart.result[0];
  const q = r.indicators.quote[0];

  return r.timestamp.map((t,i)=>({
    date: new Date(t*1000),
    open:q.open[i],
    high:q.high[i],
    low:q.low[i],
    close:q.close[i],
    volume:q.volume[i]
  })).filter(x=>x.close);
}

// === Indicators ===

function ema(values, p) {
  const k = 2/(p+1);
  let e = values[0];
  let arr = [e];
  for(let i=1;i<values.length;i++){
    e = values[i]*k + e*(1-k);
    arr.push(e);
  }
  return arr;
}

function rsi(closes, period=14){
  let gains=0, losses=0;
  for(let i=1;i<=period;i++){
    let diff = closes[i]-closes[i-1];
    if(diff>=0) gains+=diff;
    else losses-=diff;
  }
  let rs = gains/losses;
  return 100 - (100/(1+rs));
}

function vwap(data){
  let pv=0, vol=0;
  data.forEach(c=>{
    let tp=(c.high+c.low+c.close)/3;
    pv += tp*c.volume;
    vol += c.volume;
  });
  return pv/vol;
}

// === Backtest Engine ===

function backtest(data){
  const closes = data.map(d=>d.close);
  const volumes = data.map(d=>d.volume);

  const ema9 = ema(closes,9);
  const ema21 = ema(closes,21);

  let trades = [];
  let equity = 0;
  let peak = 0;
  let maxDD = 0;

  for(let i=25;i<data.length-5;i++){

    const r = rsi(closes.slice(i-15,i+1));
    const vw = vwap(data.slice(i-20,i+1));
    const avgVol = volumes.slice(i-10,i).reduce((a,b)=>a+b)/10;

    // === ENTRY CONDITION ===
    if(
      ema9[i-1] < ema21[i-1] &&
      ema9[i] > ema21[i] &&
      closes[i] > vw &&
      r > 55 && r < 70 &&
      volumes[i] > avgVol
    ){
      const entry = closes[i];
      const sl = entry * 0.995;
      const target = entry * 1.01;

      let exit = closes[i+1];
      let result = "LOSS";

      for(let j=i+1;j<i+6;j++){
        if(data[j].low <= sl){ exit = sl; result="LOSS"; break; }
        if(data[j].high >= target){ exit = target; result="WIN"; break; }
      }

      let pnl = exit - entry;
      equity += pnl;
      peak = Math.max(peak, equity);
      maxDD = Math.max(maxDD, peak - equity);

      trades.push({entry, exit, result, pnl});
    }
  }

  const wins = trades.filter(t=>t.result==="WIN").length;

  return {
    total: trades.length,
    wins,
    losses: trades.length - wins,
    winRate: trades.length ? (wins/trades.length*100).toFixed(2) : 0,
    net: equity.toFixed(2),
    maxDD: maxDD.toFixed(2),
    last: trades.at(-1)
  };
}

// === UI ===

async function run(){
  document.getElementById("stats").innerHTML = "Loading backtest...";

  const data = await fetchData("SBIN","5m","5d");
  const result = backtest(data);

  document.getElementById("stats").innerHTML = `
    <h3>SBIN 5-min Strategy Backtest</h3>
    <div>Total Trades: ${result.total}</div>
    <div>Wins: ${result.wins}</div>
    <div>Losses: ${result.losses}</div>
    <div>Win Rate: ${result.winRate}%</div>
    <div>Net P&L (points): ${result.net}</div>
    <div>Max Drawdown: ${result.maxDD}</div>
    <hr>
    <b>Latest Trade:</b><br>
    Entry: ${result.last?.entry?.toFixed(2)}<br>
    Exit: ${result.last?.exit?.toFixed(2)}<br>
    Result: ${result.last?.result}
  `;
}

run();
</script>

</body>
</html>
